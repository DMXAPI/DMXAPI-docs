---
title: 可灵 Kling 图生视频案例
gitChangelog: false
updatedAt: 2025-05-11
---

# 可灵 Kling 图生视频

这是一个图生视频的示例，使用 kling 生成视频。

> [!TIP]
> 视频生成是计算密集型任务，特别是高质量、高分辨率视频可能需要数十秒甚至数分钟处理时间，为了让用户发送请求后可以立即收到响应（任务ID），而不必等待整个生成过程，因此用户可以同时提交多个生成任务，然后异步查询结果。
> 同时这样的队列系统允许服务提供商根据可用GPU/TPU资源智能调度任务。

通常来说，视频生成的常见流程是：

1. `POST`: 调用 `生成视频api` 提交视频生成任务，返回获取 `task_id`。
2. `GET`: 根据 `task_id` 调用 `查询视频api` 查看视频生成任务是否完成。

本示例实现了每隔一秒轮询任务状态，直到任务完成，然后返回视频 url 列表。

## 代码示例

> 深色背景为可以修改的参数，非必选参数已经注释，可以按照自己的需求启用。


<<< @/zh/snippets/kling-image-to-video.py{254-255,261-272,276-296}


## 返回结果

返回结果为视频的 url 和 id，视频的有效期一般为 30 天，推荐尽快下载或者转存。

```

```

## 流程图

```mermaid
flowchart TD
    A[开始] --> B[初始化 KlingImageToVideo 实例]
    B --> C[调用 generate_video 方法]
    
    C --> D1{检查起始图片类型}
    D1 -->|URL| E1[直接使用URL]
    D1 -->|本地文件| F1[转换为base64]
    
    C --> D2{检查结束图片类型}
    D2 -->|URL| E2[直接使用URL]
    D2 -->|本地文件| F2[转换为base64]
    D2 -->|未提供| G2[跳过]
    
    C --> D3{检查静态遮罩类型}
    D3 -->|URL| E3[直接使用URL]
    D3 -->|本地文件| F3[转换为base64]
    D3 -->|未提供| G3[跳过]
    
    C --> D4{检查动态遮罩列表}
    D4 -->|存在| E4[处理每个遮罩项]
    D4 -->|未提供| G4[跳过]
    
    E4 --> F4{检查遮罩图像类型}
    F4 -->|URL| G4[直接使用URL]
    F4 -->|本地文件| H4[转换为base64]
    
    E1 --> I[准备API请求参数]
    F1 --> I
    E2 --> I
    F2 --> I
    G2 --> I
    E3 --> I
    F3 --> I
    G3 --> I
    G4 --> I
    H4 --> I
    
    I --> J[调用_kling_generate_video提交任务]
    J --> K[获取task_id]
    
    K --> L[开始轮询查询结果]
    L --> M[调用_query_video_result]
    
    M --> N{任务是否完成?}
    N -->|否| O{是否超时?}
    O -->|否| P[等待3秒]
    P --> M
    O -->|是| Q[返回超时信息]
    
    N -->|是| R[获取video_url和video_id]
    R --> S[返回结果]
    
    Q --> T[结束]
    S --> T
```